{% extends "base.html" %}

{% block content %}
<div class="container py-5 text-center">
  <h1 class="mb-4 display-5 fw-bold text-success">🎁 Redeem Eco Points</h1>
  <p class="lead">Convert your effort into rewards and support a greener future!</p>

  <div class="card shadow-lg mx-auto mt-4" style="max-width: 600px;">
    <div class="card-body p-5">
      <h4 class="mb-3 text-dark">Your Balance</h4>
      <p class="fs-1 text-success fw-bold">{{ eco_points }}</p>
      <p class="text-muted">That equals <strong>£{{ pounds }}</strong></p>

      <hr class="my-4">

      <form method="POST" class="needs-validation" novalidate>
        <div class="mb-3">
          <label for="redeem_points" class="form-label fw-semibold">Enter Points to Redeem</label>
          <input type="number" class="form-control form-control-lg text-center" name="redeem_points" id="redeem_points" placeholder="e.g., 50" min="1" max="{{ eco_points }}" required>
          <div class="form-text">10 Eco Points = £0.20</div>
        </div>
        <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">Generate QR Code</button>
      </form>

      {% if qr_url %}
      <div class="mt-5">
        <h5 class="text-success mb-3">🎉 Redemption Successful!</h5>
        <p>You redeemed <strong>{{ redeemed_points }}</strong> points = <strong>£{{ redeemed_value }}</strong></p>
        <img src="{{ qr_url }}" id="qrImage" alt="QR Code" class="img-fluid mt-3" style="max-width: 300px;">

        <div class="mt-4 d-flex justify-content-center gap-3 flex-wrap">
          <button id="downloadBtn" class="btn btn-outline-primary">⬇️ Download QR Code</button>

          {% if qr_data %}

              <form method="POST" action="{{ url_for('user_dash_bp.send_qr_email') }}">

                <input type="hidden" name="qr_data" value="{{ qr_data }}">
                <input type="hidden" name="redeemed_points" value="{{ redeemed_points }}">
                <button type="submit" class="btn btn-outline-success">📧 Email Voucher</button>
              </form>
          {% endif %}
        </div>
      </div>

      <script>
        const qrImage = document.getElementById('qrImage');
        const downloadBtn = document.getElementById('downloadBtn');

        downloadBtn.addEventListener('click', function (e) {
          e.preventDefault();
          const base64Data = qrImage.src.split(',')[1];
          const byteCharacters = atob(base64Data);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], { type: 'image/png' });
          const url = URL.createObjectURL(blob);

          const link = document.createElement('a');
          link.href = url;
          link.download = 'eco_voucher.png';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        });
      </script>
      {% endif %}

<<<<<<< HEAD
      <a href="{{ url_for('user_dash_bp.eco_points_dashboard') }}" class="btn btn-outline-secondary mt-5">← Back to Dashboard</a>
    </div>
  </div>
</div>
{% endblock %}
=======
      <a href="{{ url_for('eco_points_dashboard') }}" class="btn btn-outline-secondary mt-5">← Back to Dashboard</a>
    </div>
  </div>
</div>
{% endblock %}
>>>>>>> a445c69367a47d20470bdbf0056d85556f862b4e
